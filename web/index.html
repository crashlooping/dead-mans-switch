<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dead Man's Switch - Devices</title>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.5/dist/htmx.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
</head>
<body data-base-path="">
    <h1>Device Heartbeats</h1>
    <div id="device-table">Loading device data...</div>
    <script>
    // Get basePath from <body data-base-path>
    const basePath = document.body.getAttribute('data-base-path') || '';
    const evtSource = new EventSource(basePath + '/events');
    evtSource.onmessage = function(e) {
        document.getElementById('device-table').innerHTML = e.data;
        convertTimestamps();
    };
    function convertTimestamps() {
        document.querySelectorAll('#device-table td[data-utc]').forEach(function(cell) {
            const utc = cell.getAttribute('data-utc');
            if (utc) {
                const d = new Date(utc);
                if (!isNaN(d)) {
                    cell.textContent = d.toLocaleString();
                }
            }
        });
    }
    // Also convert on initial load (in case table is present)
    window.addEventListener('DOMContentLoaded', convertTimestamps);
    </script>
    <h2>Configured Notifications</h2>
    <div id="notification-list" hx-get="web/configured-notifications" hx-trigger="load" hx-swap="outerHTML" data-hx-base-path="">
        Loading notification channels...
    </div>
    <script>
    // Patch htmx to use basePath for all hx-get/hx-post URLs
    document.addEventListener('htmx:configRequest', function(evt) {
        const basePath = document.body.getAttribute('data-base-path') || '';
        if (evt.detail.path && !evt.detail.path.startsWith(basePath)) {
            if (evt.detail.path.startsWith('/')) {
                evt.detail.path = basePath + evt.detail.path;
            } else {
                evt.detail.path = basePath + '/' + evt.detail.path;
            }
        }
    });
    </script>
    <footer style="margin-top:2em;text-align:center;">
        <a href="https://github.com/crashlooping/dead-mans-switch/" target="_blank" style="display:inline-flex;align-items:center;gap:0.5em;">
            <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" style="vertical-align:middle;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
            View on GitHub
        </a>
    </footer>
</body>
</html>
